params {
    // Raw data directory
    dataDir             = "/media/seqadmin/datos/MN-COVID-SEQ/covid"
    scriptDir           = "${projectDir}/bin/"
    schemeDir           = "${projectDir}/schemes/"
    condaDir            = "${projectDir}/envs/conda/"
        env_general     = "${condaDir}/general.yml"
        env_artic       = "${condaDir}/artic.yml"
        env_pangolin    = "${condaDir}/pangolin.yml"
        env_nextclade   = "${condaDir}/nextclade.yml"
        env_proovframe  = "${condaDir}/proovframe.yml"

    // Output directory
    analysisDir             = null
    outDir                  = null
    tracedir = "${params.outDir}/pipeline_info"

    // Analysis specific parameters
    samplesheet     = null
    runID           = null

    // Artic parameters
    min_len             = 800 
    max_len             = 1700
    normalise           = 200
    min_depth           = 20
    min_mapq            = 20
    min_qval            = 8
    scheme_name         = "Midnight-ONT"
    scheme_ver          = "V3"
}

// Executor configuration to limit concurrent processes
executor {
    name = 'local'
    cpus = 6        // Adjust based on your workstation (leave 2+ cores for system)
    memory = '12 GB' // Adjust based on your RAM (leave 4+ GB for system)
    queueSize = 2   // Maximum concurrent processes
}

// Process-level resource configuration
process {
    executor = 'local'
    shell = ['/bin/bash', '-euo', 'pipefail']
    
    // Default resources for all processes
    cpus = 1
    memory = '2 GB'
    
    // Specific configurations for each module
    withName: 'guppyplex' {
        cpus = 1
        maxForks = 4
        memory = '2 GB'
    }
    
    withName: 'artic' {
        cpus = 2
        memory = { "${6 + task.attempt} GB" }
        maxForks = 2
        errorStrategy = { task.attempt <= 2 ? 'retry' : 'ignore' }
        maxRetries = 2
    }
        
    withName: 'coverage' {
        cpus = 1
        maxForks = 2
        memory = '2 GB'
    }
    
    withName: 'proovframe' {
        cpus = 1
        maxForks = 5
        memory = '2 GB'
    }
    
    withName: 'concatenate_consensus' {
        cpus = 1
        memory = '2 GB'
    }
    
    withName: 'alignment' {
        cpus = 2
        memory = '4 GB'
    }
    
    withName: 'nextclade' {
        cpus = 2
        memory = '3 GB'
    }
    
    withName: 'pangolin' {
        cpus = 2
        memory = '3 GB'
    }
    
}

profiles {
    conda_on {
        conda.enabled   = true
        conda.useMamba  = false
        conda.cacheDir  = "/home/seqadmin/Bioinfo/75.SARS-CoV-2/.cache/"
    }

    docker_on {
        docker.enabled = true
        // this ensures container is run as host user and group, but
        //    also adds host user to the within-container group
        docker.runOptions = "--user \$(id -u):\$(id -g) --group-add 100"
    }

    singularity_on {
        singularity.enabled = true
        singularity.autoMounts = true
    }
    
    // Profile for even more conservative resource usage
    conservative {
        executor {
            queueSize = 4
            cpus = 4
            memory = '8 GB'
        }
        process {
            cpus = 1
            memory = '1 GB'
        }
    }
}

manifest {
    mainScript = 'main.nf'
    nextflowVersion = '>=23.10.1'
}

// Timeline report - shows execution timeline and resource usage
timeline {
    enabled = true
    file = "${params.tracedir}/execution_timeline.html"
    overwrite = true
}

// Execution report - comprehensive pipeline execution report
report {
    enabled = true
    file = "${params.tracedir}/execution_report.html"
    overwrite = true
}

// Trace report - detailed task execution information
trace {
    enabled = true
    file = "${params.tracedir}/execution_trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,env,workdir,scratch,error_action'
}

// DAG visualization - shows workflow structure
dag {
    enabled = true
    file = "${params.tracedir}/pipeline_dag.svg"
    overwrite = true
}